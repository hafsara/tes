<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>
<div class="dashboard-container">
  <div class="main-content">
    <div class="card">
      <p-tabView [(activeIndex)]="activeTabIndex">
        <p-tabPanel header="Overview">
          <div class="form-main">
            <div class="card flex align-items-center justify-content-between"
                 style="margin-top: 0.7rem; margin-bottom: 2rem;">
              <div class="tags-container flex gap-2">
                <p-tag [value]="'APP: ' + formContainer.app_name"></p-tag>
                <p-tag [value]="formContainer.campaign_name" severity="info"></p-tag>
                <p-tag *ngIf="formContainer.reference" [value]="formContainer.reference" severity="info"></p-tag>
              </div>
              <div class="date-badge flex align-items-center" style="margin-left: auto;">
                <i class="pi pi-clock" style="margin-right: 0.5rem;"></i>
                <span>{{ formContainer.created_at | date: 'dd/MM/yyyy HH:mm:ss' }}</span>
              </div>
            </div>
            <div class="info-blocks flex justify-content-between mt-3">
              <div class="info-left info-div">
                <div class="info-text">
                  <strong>User Email: </strong>
                  <span>{{ formContainer.user_email }}</span>
                </div>
                <div class="info-text" *ngIf="formContainer.escalade_email">
                  <strong>Escalade Email: </strong>
                  <span>{{ formContainer.escalade_email }}</span>
                </div>
                <div class="info-text" *ngIf="formContainer.cc_emails.length > 0">
                  <strong>CC Email: </strong>
                  <span>{{ formContainer.cc_emails }}</span>
                </div>
              </div>

              <div class="info-right info-div">
                <div class="info-text">
                  <strong>Status: </strong>
                  <span>{{ currentForm.status }}</span>
                </div>
                <div class="info-text">
                  <strong>Initiated By: </strong>
                  <span>{{ formContainer.initiated_by }}</span>
                </div>
                <div class="info-text">
                  <strong>Reminder Delay: </strong>
                  <span>{{ formContainer.reminder_delay }} days</span>
                </div>
              </div>
            </div>

            <p-card header="{{ formContainer.title }}" class="card-background">
              <div class="card">
                <p-fieldset legend="Description">
                  <markdown [data]="markdownDescription"></markdown>
                </p-fieldset>
              </div>
            </p-card>

            <div *ngIf="currentForm.status === 'canceled'" class="card desc-card">
              <p-fieldset legend="Cancel justification">
                <markdown [data]="currentForm.cancel_comment"></markdown>
              </p-fieldset>
            </div>

            <div class="card desc-card">
              <p-fieldset legend="Form">
                <div *ngIf="currentForm.status === 'open' || currentForm.status === 'canceled'">
                  <app-form-preview [formQuestions]="currentForm"></app-form-preview>
                </div>
                <div *ngIf="currentForm.status !== 'open' && currentForm.status !== 'canceled'">
                  <app-form-response-preview [questions]="currentForm.questions"></app-form-response-preview>
                </div>

                <div class="centered-container-button flex justify-content-end"
                     *ngIf="currentForm.status === 'answered'">
                  <div class="button-group">
                    <p-button label="Ask again" class="custom-button" [outlined]="true"
                              (onClick)="verifAddNewForm()"></p-button>
                    <p-button label="Validate" class="custom-button" [outlined]="true"
                              (onClick)="validateFormContainer($event)"></p-button>
                  </div>
                </div>
                <div class="centered-container-button flex justify-content-end"
                     *ngIf="currentForm.status === 'open'">
                  <div class="button-group">
                    <p-button label="Cancel" class="custom-button" (onClick)="showCancelComment()"></p-button>
                  </div>
                </div>
              </p-fieldset>
            </div>
          </div>
        </p-tabPanel>

        <p-tabPanel header="Timeline" (click)="sidebarVisible=false">
          <ng-template pTemplate="content">
            <app-timeline [formContainerId]="formContainer.id"></app-timeline>
          </ng-template>
        </p-tabPanel>
      </p-tabView>
    </div>
  </div>

  <div class="sidebar-toggle-button" (click)="toggleSidebar()" *ngIf="historyForms.length > 0">
    <i class="pi pi-bars"></i>
  </div>

  <div class="sidebar" *ngIf="sidebarVisible && historyForms.length > 0">
    <h4>Previous Forms</h4>
    <ul>
      <li *ngFor="let form of formContainer.forms; let i = index" (click)="selectForm(form)"
          [class.active]="form === currentForm">
        <button (click)="selectPreviousForm(form)">
          <i class="pi pi-star"></i> {{ form.created_at | date: 'dd/MM/yyyy HH:mm:ss' }}
        </button>
      </li>
    </ul>
  </div>

  <p-dialog header="Add new form" [modal]="true" [(visible)]="visible" [style]="{ width: '50rem' }"
            [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }" (onHide)="resetForm()">
    <app-form-builder [form]="newForm" [showErrors]="showErrors"></app-form-builder>
    <div class="flex pt-4 justify-content-between">
      <p-button label="Cancel" severity="secondary" (onClick)="resetForm()"/>
      <p-button label="Save" (onClick)="addForm($event)"/>
    </div>
  </p-dialog>
</div>

<p-dialog header="Add cancel comment" [modal]="true" [(visible)]="cancelVisible" [style]="{ width: '25rem' }">
  <span class="p-text-secondary block mb-5">Please add cancel justification</span>
  <div>
    <textarea rows="5" cols="30" [(ngModel)]="cancelComment"></textarea>
    <small *ngIf="showCommentError" class="p-error">Comment must be at least 4 characters.</small>
  </div>
  <div class="flex pt-4 justify-content-between">
    <p-button label="Cancel" severity="secondary" (onClick)="cancelVisible = false"/>
    <p-button label="Save" (onClick)="cancelForm()"/>
  </div>
</p-dialog>
