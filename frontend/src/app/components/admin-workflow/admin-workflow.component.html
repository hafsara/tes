<div class="workflows-header">
  <h2>Workflow Manager</h2>
  <p-toggleButton
    [(ngModel)]="showCreation"
    onLabel="Close workflow"
    offLabel="New workflow"
    onIcon="pi pi-minus"
    offIcon="pi pi-plus"/>
</div>

<p-table [value]="workflows" *ngIf="!showCreation && workflows && workflows.length > 0">
  <ng-template pTemplate="header">
    <tr>
      <th>Workflow ID</th>
      <th>Workflow name</th>
      <th>Created by</th>
      <th style="width: 7rem"></th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-workflow>
    <tr>
      <td>{{ workflow.id }}</td>
      <td>{{ workflow.name }}</td>
      <td>{{ workflow.created_by }}</td>
      <td>
        <div class="action-icons">
          <i class="pi pi-eye" (click)="viewWorkflow(workflow.steps)" title="View"></i>
          <i class="pi pi-ban" (click)="deleteWorkflow(workflow.id)" title="Delete"></i>
        </div>
      </td>
    </tr>
  </ng-template>
</p-table>

<div *ngIf="!showCreation && (!workflows || workflows.length === 0)" class="empty-state">
  <p>You have no workflows yet.</p>
</div>

<div *ngIf="showCreation" class="workflow-container">
  <div cdkDropList [cdkDropListData]="steps" (cdkDropListDropped)="drop($event)" class="workflow-container">
    <div *ngFor="let step of steps" cdkDrag class="draggable-step">
      <p-panel [header]="step.label"
               class="step-panel"
               [collapsed]="true"
               toggleable="true">
        <ng-template pTemplate="icons">
          <button class="p-panel-header-icon p-link mr-2" (click)="openContextMenu($event, step, menu)">
            <span class="pi pi-cog"></span>
          </button>
          <p-menu #menu id="config_menu" [model]="items" [popup]="true"/>
        </ng-template>

        <div class="step-details">
          <p>Type: {{ step.type }}</p>
          <p>Delay: {{ step.delay }} days</p>
        </div>
      </p-panel>
    </div>
  </div>

  <div class="workflow-actions">
    <p-button label="Add Step" icon="pi pi-plus" (click)="addStep()"></p-button>
    <p-button label="Save" icon="pi pi-save" class="p-button-success" (click)="saveWorkflow()"></p-button>
  </div>
</div>
<p-dialog [(visible)]="displayDialog" [modal]="true" *ngIf="selectedStep">
  <h3>{{ isEditing ? 'Edit Step' : 'Add Step' }}</h3>
  <div>
    <label>Type:</label>
    <p-dropdown [options]="availableTypes" [(ngModel)]="selectedStep.type"
                [disabled]="selectedStep.type === 'start'"></p-dropdown>
  </div>
  <div>
    <label>Delay (days):</label>
    <input type="number" pInputText [(ngModel)]="selectedStep.delay">
  </div>
  <p-button label="Confirm" (click)="isEditing ? updateStep() : confirmAddStep()"></p-button>
</p-dialog>

<p-dialog [(visible)]="displayWorkflowDialog" [modal]="true">
  <h3>Save Workflow</h3>
  <div>
    <label>Workflow Name:</label>
    <input type="text" pInputText [(ngModel)]="workflowName">
  </div>
  <p-button label="Save" icon="pi pi-save" class="p-button-success" (click)="confirmSaveWorkflow()"></p-button>
</p-dialog>

<p-dialog [(visible)]="showWorkflowDetails" [modal]="true" [style]="{ width: '35rem' }">
  <h3>Workflow Details</h3>
  <p-panel *ngFor="let step of selectedWorkflowSteps"
           [header]="step.label"
           class="step-panel"
           toggleable="true">
    <div class="step-details">
      <p>Type: {{ step.type }}</p>
      <p>Delay: {{ step.delay }} days</p>
    </div>
  </p-panel>
</p-dialog>
